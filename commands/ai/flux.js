import axios from 'axios';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export default {
  name: "flux",
  aliases: ["fluxai", "imageai", "generate", "aiimage"],
  category: "ai",
  description: "Generate an image using Flux AI",
  
  async execute(sock, m, args, PREFIX) {
    const jid = m.key.remoteJid;
    
    // Check if query is provided
    if (args.length === 0) {
      return sock.sendMessage(jid, {
        text: `‚ï≠‚îÄ‚åà üé® *FLUX AI* ‚åã\n‚îú‚îÄ‚ä∑ *${PREFIX}flux <prompt>*\n‚îÇ  ‚îî‚ä∑ Generate AI image from text\n‚îú‚îÄ‚ä∑ *${PREFIX}fluxai <prompt>*\n‚îÇ  ‚îî‚ä∑ Alias for flux\n‚ï∞‚îÄ‚îÄ‚îÄ`
      }, { quoted: m });
    }

    const query = args.join(' ');
    const encodedQuery = encodeURIComponent(query);
    
    try {
      await sock.sendMessage(jid, { react: { text: '‚è≥', key: m.key } });

      // Call Flux API with arraybuffer response
      const apiUrl = `https://apiskeith.vercel.app/ai/flux?q=${encodedQuery}`;
      
      console.log(`[FLUX] Generating image for: "${query}"`);
      console.log(`[FLUX] API URL: ${apiUrl}`);
      
      const response = await axios.get(apiUrl, {
        responseType: 'arraybuffer',
        timeout: 60000, // 60 second timeout
        headers: {
          'User-Agent': 'WolfBot/1.0',
          'Accept': 'image/jpeg,image/png'
        }
      });

      if (!response.data || response.data.length === 0) {
        throw new Error('Empty response from AI');
      }

      console.log(`[FLUX] Received image data: ${response.data.length} bytes`);

      // Create temp directory if it doesn't exist
      const tempDir = path.join(__dirname, 'temp');
      if (!fs.existsSync(tempDir)) {
        fs.mkdirSync(tempDir, { recursive: true });
      }

      // Generate unique filename
      const timestamp = Date.now();
      const filename = `flux_${timestamp}.jpg`;
      const filePath = path.join(tempDir, filename);

      // Save image to file
      fs.writeFileSync(filePath, response.data);
      console.log(`[FLUX] Image saved to: ${filePath}`);

      // Send the generated image
      await sock.sendMessage(jid, {
        image: fs.readFileSync(filePath),
        caption: `üé® *FLUX AI Generated Image*\n\n_Created by WOLFBOT_`
      }, { quoted: m });

      // Delete the temporary file
      fs.unlinkSync(filePath);
      console.log(`[FLUX] Temporary file deleted: ${filePath}`);

      await sock.sendMessage(jid, { react: { text: '‚úÖ', key: m.key } });

    } catch (error) {
      console.error('[FLUX] Error:', error.message);
      
      let errorMessage = `‚ùå *Image Generation Failed*\n\n`;
      
      if (error.code === 'ECONNREFUSED' || error.code === 'ENOTFOUND') {
        errorMessage += `‚Ä¢ Flux API is unavailable\n`;
        errorMessage += `‚Ä¢ Try again later\n\n`;
      } else if (error.response) {
        if (error.response.status === 404) {
          errorMessage += `‚Ä¢ API endpoint not found\n\n`;
        } else if (error.response.status === 500) {
          errorMessage += `‚Ä¢ AI server error\n`;
          errorMessage += `‚Ä¢ Try different prompt\n\n`;
        } else {
          errorMessage += `‚Ä¢ API Error: ${error.response.status}\n\n`;
        }
      } else if (error.code === 'ETIMEDOUT') {
        errorMessage += `‚Ä¢ Generation timeout (60s)\n`;
        errorMessage += `‚Ä¢ Try simpler prompt\n`;
        errorMessage += `‚Ä¢ Server might be busy\n\n`;
      } else if (error.message.includes('Empty response')) {
        errorMessage += `‚Ä¢ AI returned empty image\n`;
        errorMessage += `‚Ä¢ Try different prompt\n\n`;
      } else {
        errorMessage += `‚Ä¢ Error: ${error.message}\n\n`;
      }
      
      errorMessage += `üí° *Tips for better results:*\n`;
      errorMessage += `‚Ä¢ Be descriptive with your prompt\n`;
      errorMessage += `‚Ä¢ Avoid very complex requests\n`;
      errorMessage += `‚Ä¢ Try English prompts\n`;
      errorMessage += `‚Ä¢ Keep prompts under 100 characters\n\n`;
      
      errorMessage += `üìå *Usage:* \`${PREFIX}flux your prompt\`\n`;
      errorMessage += `üìù *Example:* \`${PREFIX}flux cyberpunk city\``;
      
      await sock.sendMessage(jid, {
        text: errorMessage
      }, { quoted: m });
      
      // Send error reaction
      await sock.sendMessage(jid, {
        react: { text: '‚ùå', key: m.key }
      });
    }
  }
};